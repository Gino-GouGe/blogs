<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="This is the 1st blog about my progress in MIT 6.5840. Came up this idea to 1st summarize my understanding and implementation and 2nd share my learnings. I would cover Lab1, MapReduce and Lab2, simple KV server in future posts.\nAccording to the policy, my github repo is private and the code blocks below are pseudo-code explaining the algorithm.\nWhat is Raft? Raft is a consensus algorithm for managing replicated state machines. The key compositions of Raft are Leader Election, Log Replication and Safety. Safety puts additional constrains on Leader Election and Log Replication to guarantee the elected leader preserves all the committed states. Other than algorithm correctness and efficiency, one of the goals of Raft is understandability. i.e. to facilitate the development of intuitions that are essential to system builders. System builders can not only understand how it works but why it works to adjust/improve the algorithm for practical use-cases.\n"><title>Raft Leader Election</title><link rel=canonical href=https://Gino-GouGe.github.io/blogs/p/raft-leader-election/><link rel=stylesheet href=/blogs/scss/style.min.833d6eed45de56f48306bf57268d5b8cdfc8a60e8e7bdc99810464fcd033f7c6.css><meta property='og:title' content="Raft Leader Election"><meta property='og:description' content="This is the 1st blog about my progress in MIT 6.5840. Came up this idea to 1st summarize my understanding and implementation and 2nd share my learnings. I would cover Lab1, MapReduce and Lab2, simple KV server in future posts.\nAccording to the policy, my github repo is private and the code blocks below are pseudo-code explaining the algorithm.\nWhat is Raft? Raft is a consensus algorithm for managing replicated state machines. The key compositions of Raft are Leader Election, Log Replication and Safety. Safety puts additional constrains on Leader Election and Log Replication to guarantee the elected leader preserves all the committed states. Other than algorithm correctness and efficiency, one of the goals of Raft is understandability. i.e. to facilitate the development of intuitions that are essential to system builders. System builders can not only understand how it works but why it works to adjust/improve the algorithm for practical use-cases.\n"><meta property='og:url' content='https://Gino-GouGe.github.io/blogs/p/raft-leader-election/'><meta property='og:site_name' content='GouGe'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2025-12-16T00:00:00+00:00'><meta property='article:modified_time' content='2025-12-16T00:00:00+00:00'><meta name=twitter:title content="Raft Leader Election"><meta name=twitter:description content="This is the 1st blog about my progress in MIT 6.5840. Came up this idea to 1st summarize my understanding and implementation and 2nd share my learnings. I would cover Lab1, MapReduce and Lab2, simple KV server in future posts.\nAccording to the policy, my github repo is private and the code blocks below are pseudo-code explaining the algorithm.\nWhat is Raft? Raft is a consensus algorithm for managing replicated state machines. The key compositions of Raft are Leader Election, Log Replication and Safety. Safety puts additional constrains on Leader Election and Log Replication to guarantee the elected leader preserves all the committed states. Other than algorithm correctness and efficiency, one of the goals of Raft is understandability. i.e. to facilitate the development of intuitions that are essential to system builders. System builders can not only understand how it works but why it works to adjust/improve the algorithm for practical use-cases.\n"><link rel="shortcut icon" href=/favicon.svg></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blogs/><img src=/blogs/img/cute_coding_dog_hu_80330de7fd67d348.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>üç•</span></figure><div class=site-meta><h1 class=site-name><a href=/blogs>GouGe</a></h1><h2 class=site-description>I turn coffee into bugs</h2></div></header><ol class=menu-social><li><a href=https://github.com/Gino-GouGe target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blogs/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/blogs/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/blogs/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/blogs/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#what-is-raft>What is Raft?</a></li><li><a href=#leader-election>Leader Election</a></li><li><a href=#implementation>Implementation</a><ol><li><a href=#raft-structure>Raft Structure</a></li><li><a href=#requestvoterpc>RequestVoteRPC</a></li><li><a href=#appendentriesrpc>AppendEntriesRPC</a></li></ol></li><li><a href=#ref>Ref</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/blogs/categories/distributed-system/>Distributed System
</a><a href=/blogs/categories/raft/>Raft</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blogs/p/raft-leader-election/>Raft Leader Election</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-12-16T00:00:00Z>Dec 16, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p>This is the 1st blog about my progress in <a class=link href=https://pdos.csail.mit.edu/6.824/index.html target=_blank rel=noopener>MIT 6.5840</a>. Came up this idea to 1st summarize my understanding and implementation and 2nd share my learnings. I would cover Lab1, MapReduce and Lab2, simple KV server in future posts.</p><p>According to the <a class=link href=https://pdos.csail.mit.edu/6.824/labs/collab.html target=_blank rel=noopener>policy</a>, my github repo is private and the code blocks below are pseudo-code explaining the algorithm.</p><h2 id=what-is-raft>What is Raft?</h2><p>Raft is a consensus algorithm for managing replicated state machines. The key compositions of Raft are Leader Election, Log Replication and Safety. Safety puts additional constrains on Leader Election and Log Replication to guarantee the elected leader preserves all the committed states. Other than algorithm correctness and efficiency, one of the goals of Raft is understandability. i.e. to facilitate the development of intuitions that are essential to system builders. System builders can not only understand how it works but why it works to adjust/improve the algorithm for practical use-cases.</p><p>A basic Raft requires only Leader Election and Log Replication. This blog is on Leader Election (w\o Safety. Safety would be expanded later in Log Replication).</p><h2 id=leader-election>Leader Election</h2><p>Raft operates on a cluster of odd numbered servers, e.g. a cluster of 3/5/7. 5 is a typical number and can tolerate 2 failures. The state machine and transition is depicted below</p><p><img src=/blogs/p/raft-leader-election/state_machine.png width=654 height=270 srcset="/blogs/p/raft-leader-election/state_machine_hu_31f6b60bf60f4508.png 480w, /blogs/p/raft-leader-election/state_machine_hu_8bedf79851376f89.png 1024w" loading=lazy alt="State Machine Transition" class=gallery-image data-flex-grow=242 data-flex-basis=581px></p><ol><li>Every server can be in 3 states &ldquo;follower&rdquo;, &ldquo;candidate&rdquo;, &ldquo;leader&rdquo;. They start at &ldquo;follower&rdquo; state and wait for some time pass to start Leader Election. The preset timeout is called &ldquo;Election Timeout&rdquo;</li><li>After randomized Election Timeout, one server switches state to &ldquo;candidate&rdquo;, bumps up its term, votes for itself and sends RequestVote RPCs to other servers in the cluster</li><li>Candidate, the sender collects &ldquo;# of votes got&rdquo; and &ldquo;# of requests sent&rdquo; and can run into 4 scenarios below<ul><li>Gets majority votes (of a full cluster), steps up to &ldquo;leader&rdquo; and send HeartBeat (empty AppendEntries) immediately to establish authority</li><li>Split vote, i.e. a candidate doesn&rsquo;t get majority votes. It restarts Leader Election. Split votes usually caused by multiple servers start Leader Election simultaneously. To prevent constant split vote, a randomized Election Timeout is employed on each server</li><li>Discovers a higher term, updates term to higher term and steps down to follower</li><li>Upon Election Timeout, the candidate restarts Leader Election and the pending election attempt is discarded or ignored.</li></ul></li><li>Leader needs to send periodic HeartBeat to followers to maintain its authority</li></ol><blockquote><p><strong>Note:</strong> For the 3rd scenario in bullet 3, the primary goal to update term to higher term upon discovery is to bring eligible candidate up to the matching term with in-eligible (i.e. network partitioned) candidate with in-complete logs, where the in-eligible candidate just keeps bumping up its term. It will make more sense after Safety. A rough example,</p><ul><li>S0 is elected as leader and sending HeartBeat in term 1</li><li>S2 is partitioned, doesn&rsquo;t receive HeartBeat, goes into leader election process</li><li>S2 never successfully elected as a leader because of no majority votes from either S0 or S1. And it keeps triggering Leader Election with term bumping up.</li><li>After some time the replicated logs are [0,1,1] (only term), [0,1,1] and [] respectively on S0, S1, S2. S0 is partitioned, S2 gets back and new leader should be elected between S1 and S2. In this case, S1 should be the only server elected because it has the complete logs. However S1 is on term 1 and S2 can be on term 100 and leader election will always fail without bring term up-to-date upon discovery.</li></ul></blockquote><h2 id=implementation>Implementation</h2><h3 id=raft-structure>Raft Structure</h3><p>A recommended approach is to use different threads to handle LeaderElection, AppendEntries, ApplyStateMachine etc. It&rsquo;s beneficial in both debugging and decoupling function call frequency. Most of the time, sleep in LeaderElection loop should longer than 2-3 times of AppendEntries RPC round trips to avoid too-frequent attempt of Leader Election. Sometimes the network package just drops and server doesn&rsquo;t get response</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>rf</span><span class=w> </span><span class=o>*</span><span class=nx>Raft</span><span class=p>)</span><span class=w> </span><span class=nf>MakeRaftInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// initialize states</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=nf>initLeaderElection</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=nx>raft_is_not_killed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>follower</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>candidate</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>electionTimeoutPassed</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>go</span><span class=w> </span><span class=nf>attemptLeaderElection</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>sleep</span><span class=p>((</span><span class=mi>700</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>jitter</span><span class=p>)</span><span class=nx>ms</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=nf>initAppendEntries</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=nx>raft_is_not_killed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>leader</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>go</span><span class=w> </span><span class=nf>sendAppendEntries</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>sleep</span><span class=p>(</span><span class=mi>100</span><span class=nx>ms</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=requestvoterpc>RequestVoteRPC</h3><p>Election Timeout is the only thing determines whether a server should attempt Leader Election and Raft instance have a dedicate state for that. It&rsquo;s very critical to reset Election Timeout in and only in 3 scenarios: candidate attempts Leader Election, follower receives AppendEntries RPC and follower grants a vote. Otherwise, likely Raft cluster will enter a livelock without any progress and you will never find it without serious debugging (Log every RPC request/response, grab a piece of paper, draw all the events in a chronological order, notice the cluster is always doing Leader Election from different servers without converge and have a head-scratcher&mldr; like me spending couple hours :&lt; ). A conceptual example can be illustrated below:</p><ul><li>S0, S1, S2, S3, S4 are having logs [0,1,2], [0,1,2], [], [], [] respectively. And suddenly S0 is partitioned</li><li>The only server has the complete log is S1, however S1, S2, S3, S4 have equal probability to attempt Leader Election. And S1&rsquo;s Leader Election is likely to be interrupted by other servers b\c of split vote or higher term</li><li>Resetting Election Timeout suppresses the Leader Election from in-eligible servers, for example S3, S4 and S1 has a lower chance to be interrupted and consequently higher chance to be elected.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Sender</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>rf</span><span class=w> </span><span class=o>*</span><span class=nx>Raft</span><span class=p>)</span><span class=w> </span><span class=nf>attemptLeaderElection</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>state</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>Candidate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>currentTerm</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>votedFor</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>self</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>reset_election_timeout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>votesReceivedCnt</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sendRequestCnt</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>follower</span><span class=w> </span><span class=nx>in</span><span class=w> </span><span class=nx>followers</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>sendRequestVote</span><span class=p>(</span><span class=nx>server</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>args</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>reply</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>rpc_timeout_or_fail</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>discover_higher_term</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>convert_to_follower</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>receive_old_rpc</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>simply_discard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>receive_vote</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>votesReceivedCnt</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>sendRequestCnt</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>waitUntilEither</span><span class=p>(</span><span class=nx>votesReceivedCnt</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>followers</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=w> </span><span class=nx>or</span><span class=w> </span><span class=nx>sendRequestCnt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>followers</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>get_majority_votes</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>state</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>Leader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>go</span><span class=w> </span><span class=nf>sendAppendEntries</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>rf</span><span class=w> </span><span class=o>*</span><span class=nx>Raft</span><span class=p>)</span><span class=w> </span><span class=nf>RequestVote</span><span class=p>(</span><span class=nx>args</span><span class=w> </span><span class=o>*</span><span class=nx>RequestVoteArgs</span><span class=p>,</span><span class=w> </span><span class=nx>reply</span><span class=w> </span><span class=o>*</span><span class=nx>RequestVoteReply</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>reject_vote</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** Additional Safety constrains to determine whether a candidate can be elected **/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>approve_vote</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>reset_election_timeout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>approve_vote</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>reset_election_timeout</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nx>neverVoted</span><span class=w> </span><span class=nx>or</span><span class=w> </span><span class=nx>votedFor</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=nx>approve_vote</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=appendentriesrpc>AppendEntriesRPC</h3><p>In Leader Election, AppendEntries RPC is like a heartbeat sending empty entries. The only thing is to reset Election Timeout on receiver</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Sender</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>rf</span><span class=w> </span><span class=o>*</span><span class=nx>Raft</span><span class=p>)</span><span class=w> </span><span class=nf>sendAppendEntries</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>follower</span><span class=w> </span><span class=nx>in</span><span class=w> </span><span class=nx>followers</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>sendAppendEntries</span><span class=p>(</span><span class=nx>server</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>args</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>reply</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>rf</span><span class=w> </span><span class=o>*</span><span class=nx>Raft</span><span class=p>)</span><span class=w> </span><span class=nf>AppendEntries</span><span class=p>(</span><span class=nx>args</span><span class=w> </span><span class=o>*</span><span class=nx>AppendEntriesArgs</span><span class=p>,</span><span class=w> </span><span class=nx>reply</span><span class=w> </span><span class=o>*</span><span class=nx>AppendEntriesReply</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>reject_entries</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>reset_election_timeout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=ref>Ref</h2><ul><li><a class=link href=https://raft.github.io/raft.pdf target=_blank rel=noopener>Raft Paper</a></li><li><a class=link href=https://pdos.csail.mit.edu/6.824/labs/raft-structure.txt target=_blank rel=noopener>Suggestions on Raft Structure</a></li><li><a class=link href=https://pdos.csail.mit.edu/6.824/labs/raft-locking.txt target=_blank rel=noopener>Raft Locking Advice</a></li></ul></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/blogs/p/raft-log-replication/><div class=article-details><h2 class=article-title>Raft Log Replication</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2025 GouGe</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blogs/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>